#!/bin/bash
#
# JPS Reinstall WordPress
# Safely reinstalls WordPress on an existing site while preserving the database
#
# Usage: jps-reinstall-wp <domain> [options]
# Options:
#   --preserve-uploads  Keep the wp-content/uploads directory
#   --force            Skip interactive confirmations (for API use)
#   --json             Output results in JSON format
#   --help             Show this help message
#

set -euo pipefail

# Configuration
WEBSITES_ROOT="/usr/local/websites"
BACKUP_ROOT="/var/backups/jps-sites"
LOG_DIR="/opt/jps-server-tools/logs/lifecycle"
WEB_USER="nobody"
WEB_GROUP="nogroup"
SCRIPT_NAME="jps-reinstall-wp"
VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Flags
PRESERVE_UPLOADS=false
FORCE_MODE=false
JSON_OUTPUT=false
DOMAIN=""

# Logging
log_file=""

log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    if [[ -n "$log_file" ]]; then
        echo "[$timestamp] [$level] $message" >> "$log_file"
    fi

    if [[ "$JSON_OUTPUT" == "false" ]]; then
        case "$level" in
            "INFO")  echo -e "${CYAN}[INFO]${NC} $message" ;;
            "SUCCESS") echo -e "${GREEN}[SUCCESS]${NC} $message" ;;
            "WARNING") echo -e "${YELLOW}[WARNING]${NC} $message" ;;
            "ERROR") echo -e "${RED}[ERROR]${NC} $message" ;;
            *) echo "$message" ;;
        esac
    fi
}

json_output() {
    local status="$1"
    local message="$2"
    local data="${3:-{}}"

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "{\"success\": $status, \"message\": \"$message\", \"data\": $data}"
    fi
}

show_help() {
    cat << EOF
JPS Reinstall WordPress v${VERSION}

Safely reinstalls WordPress on an existing site while preserving the database.

Usage: $SCRIPT_NAME <domain> [options]

Options:
    --preserve-uploads  Keep the wp-content/uploads directory
    --force            Skip interactive confirmations (for API use)
    --json             Output results in JSON format
    --help             Show this help message

Examples:
    $SCRIPT_NAME example.com
    $SCRIPT_NAME example.com --preserve-uploads
    $SCRIPT_NAME example.com --force --json

Safety Features:
    - Creates full backup before any changes
    - Requires 3 confirmations in interactive mode
    - Preserves database and credentials
    - Logs all actions

EOF
    exit 0
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --preserve-uploads)
                PRESERVE_UPLOADS=true
                shift
                ;;
            --force)
                FORCE_MODE=true
                shift
                ;;
            --json)
                JSON_OUTPUT=true
                shift
                ;;
            --help|-h)
                show_help
                ;;
            -*)
                echo "Unknown option: $1"
                exit 1
                ;;
            *)
                if [[ -z "$DOMAIN" ]]; then
                    DOMAIN="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$DOMAIN" ]]; then
        if [[ "$JSON_OUTPUT" == "true" ]]; then
            json_output "false" "Domain is required"
        else
            echo "Error: Domain is required"
            echo "Usage: $SCRIPT_NAME <domain> [options]"
        fi
        exit 1
    fi
}

validate_domain() {
    local site_path="$WEBSITES_ROOT/$DOMAIN"

    # Check if site directory exists
    if [[ ! -d "$site_path" ]]; then
        log "ERROR" "Site directory not found: $site_path"
        json_output "false" "Site directory not found"
        exit 1
    fi

    # Check if wp-config.php exists
    if [[ ! -f "$site_path/html/wp-config.php" ]]; then
        log "ERROR" "wp-config.php not found - this doesn't appear to be a WordPress site"
        json_output "false" "wp-config.php not found"
        exit 1
    fi

    log "INFO" "Validated domain: $DOMAIN"
}

extract_db_credentials() {
    local wp_config="$WEBSITES_ROOT/$DOMAIN/html/wp-config.php"

    DB_NAME=$(grep "DB_NAME" "$wp_config" | cut -d "'" -f 4)
    DB_USER=$(grep "DB_USER" "$wp_config" | cut -d "'" -f 4)
    DB_PASSWORD=$(grep "DB_PASSWORD" "$wp_config" | cut -d "'" -f 4)
    DB_HOST=$(grep "DB_HOST" "$wp_config" | cut -d "'" -f 4)
    TABLE_PREFIX=$(grep "table_prefix" "$wp_config" | cut -d "'" -f 2)

    # Default values if not found
    DB_HOST="${DB_HOST:-localhost}"
    TABLE_PREFIX="${TABLE_PREFIX:-wp_}"

    if [[ -z "$DB_NAME" ]] || [[ -z "$DB_USER" ]] || [[ -z "$DB_PASSWORD" ]]; then
        log "ERROR" "Could not extract database credentials from wp-config.php"
        json_output "false" "Could not extract database credentials"
        exit 1
    fi

    log "INFO" "Extracted database credentials (DB: $DB_NAME, User: $DB_USER)"
}

get_site_info() {
    local site_path="$WEBSITES_ROOT/$DOMAIN/html"

    # Get WordPress version
    WP_VERSION="unknown"
    if [[ -f "$site_path/wp-includes/version.php" ]]; then
        WP_VERSION=$(grep "wp_version = " "$site_path/wp-includes/version.php" | cut -d "'" -f 2)
    fi

    # Get site size
    SITE_SIZE=$(du -sh "$site_path" 2>/dev/null | cut -f1)

    # Get uploads size if exists
    UPLOADS_SIZE="0"
    if [[ -d "$site_path/wp-content/uploads" ]]; then
        UPLOADS_SIZE=$(du -sh "$site_path/wp-content/uploads" 2>/dev/null | cut -f1)
    fi

    # Get database size
    DB_SIZE=$(mysql -u "$DB_USER" -p"$DB_PASSWORD" -h "$DB_HOST" -N -e \
        "SELECT ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) FROM information_schema.tables WHERE table_schema = '$DB_NAME';" 2>/dev/null || echo "unknown")
    DB_SIZE="${DB_SIZE:-unknown} MB"
}

interactive_confirm() {
    if [[ "$FORCE_MODE" == "true" ]]; then
        return 0
    fi

    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${RED}                    ⚠️  WARNING: DESTRUCTIVE OPERATION ⚠️${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "You are about to ${RED}REINSTALL WORDPRESS${NC} on: ${CYAN}$DOMAIN${NC}"
    echo ""
    echo "This will:"
    echo -e "  ${RED}✗${NC} Delete all WordPress core files"
    echo -e "  ${RED}✗${NC} Delete all themes (except uploads if --preserve-uploads)"
    echo -e "  ${RED}✗${NC} Delete all plugins"
    if [[ "$PRESERVE_UPLOADS" == "true" ]]; then
        echo -e "  ${GREEN}✓${NC} PRESERVE wp-content/uploads"
    else
        echo -e "  ${RED}✗${NC} Delete wp-content/uploads"
    fi
    echo -e "  ${GREEN}✓${NC} Preserve database (all posts, pages, settings)"
    echo -e "  ${GREEN}✓${NC} Create backup before changes"
    echo ""
    echo "Site Information:"
    echo "  WordPress Version: $WP_VERSION"
    echo "  Site Size: $SITE_SIZE"
    echo "  Uploads Size: $UPLOADS_SIZE"
    echo "  Database Size: $DB_SIZE"
    echo ""

    # Confirmation 1: Yes/No
    echo -e "${YELLOW}Confirmation 1 of 3:${NC}"
    read -p "Do you want to proceed? (yes/no): " confirm1
    if [[ "$confirm1" != "yes" ]]; then
        log "INFO" "Reinstall cancelled by user (confirmation 1)"
        echo "Operation cancelled."
        exit 0
    fi

    # Confirmation 2: Type domain
    echo ""
    echo -e "${YELLOW}Confirmation 2 of 3:${NC}"
    read -p "Type the domain name exactly to confirm [$DOMAIN]: " confirm2
    if [[ "$confirm2" != "$DOMAIN" ]]; then
        log "INFO" "Reinstall cancelled by user (confirmation 2 - domain mismatch)"
        echo "Domain does not match. Operation cancelled."
        exit 0
    fi

    # Confirmation 3: Type REINSTALL
    echo ""
    echo -e "${YELLOW}Confirmation 3 of 3:${NC}"
    read -p "Type 'REINSTALL' in capital letters to confirm: " confirm3
    if [[ "$confirm3" != "REINSTALL" ]]; then
        log "INFO" "Reinstall cancelled by user (confirmation 3)"
        echo "Confirmation text does not match. Operation cancelled."
        exit 0
    fi

    echo ""
    log "INFO" "All confirmations passed, proceeding with reinstall"
}

create_backup() {
    local timestamp=$(date '+%Y%m%d_%H%M%S')
    local backup_dir="$BACKUP_ROOT/$DOMAIN"
    local backup_name="reinstall_backup_${timestamp}"
    local backup_path="$backup_dir/$backup_name"

    log "INFO" "Creating backup at $backup_path"

    # Create backup directory
    mkdir -p "$backup_path"

    # Backup files
    log "INFO" "Backing up files..."
    tar -czf "$backup_path/files.tar.gz" -C "$WEBSITES_ROOT/$DOMAIN" html 2>/dev/null || {
        log "ERROR" "Failed to backup files"
        json_output "false" "Failed to backup files"
        exit 1
    }

    # Backup database
    log "INFO" "Backing up database..."
    mysqldump -u "$DB_USER" -p"$DB_PASSWORD" -h "$DB_HOST" "$DB_NAME" > "$backup_path/database.sql" 2>/dev/null || {
        log "ERROR" "Failed to backup database"
        json_output "false" "Failed to backup database"
        exit 1
    }

    # Save metadata
    cat > "$backup_path/metadata.json" << EOF
{
    "domain": "$DOMAIN",
    "timestamp": "$timestamp",
    "wp_version": "$WP_VERSION",
    "site_size": "$SITE_SIZE",
    "db_name": "$DB_NAME",
    "preserve_uploads": $PRESERVE_UPLOADS,
    "backup_reason": "wordpress_reinstall"
}
EOF

    # Set permissions
    chmod -R 600 "$backup_path"

    BACKUP_PATH="$backup_path"
    log "SUCCESS" "Backup created successfully at $backup_path"
}

preserve_uploads() {
    local site_path="$WEBSITES_ROOT/$DOMAIN/html"
    local uploads_path="$site_path/wp-content/uploads"
    local temp_uploads="/tmp/jps_uploads_${DOMAIN}_$$"

    if [[ "$PRESERVE_UPLOADS" == "true" ]] && [[ -d "$uploads_path" ]]; then
        log "INFO" "Preserving uploads directory..."
        mv "$uploads_path" "$temp_uploads"
        TEMP_UPLOADS_PATH="$temp_uploads"
    else
        TEMP_UPLOADS_PATH=""
    fi
}

restore_uploads() {
    local site_path="$WEBSITES_ROOT/$DOMAIN/html"
    local uploads_path="$site_path/wp-content/uploads"

    if [[ -n "${TEMP_UPLOADS_PATH:-}" ]] && [[ -d "$TEMP_UPLOADS_PATH" ]]; then
        log "INFO" "Restoring uploads directory..."
        mkdir -p "$site_path/wp-content"
        mv "$TEMP_UPLOADS_PATH" "$uploads_path"
        chown -R "$WEB_USER:$WEB_GROUP" "$uploads_path"
    fi
}

reinstall_wordpress() {
    local site_path="$WEBSITES_ROOT/$DOMAIN/html"

    # Preserve uploads if requested
    preserve_uploads

    # Remove all files except uploads (if preserved)
    log "INFO" "Removing existing WordPress files..."
    find "$site_path" -mindepth 1 -delete 2>/dev/null || {
        # If find fails, try rm
        rm -rf "$site_path"/*
    }

    # Download fresh WordPress
    log "INFO" "Downloading fresh WordPress..."
    cd "$site_path"

    if command -v wp &> /dev/null; then
        # Use WP-CLI if available
        sudo -u "$WEB_USER" wp core download --path="$site_path" --allow-root 2>/dev/null || \
        wp core download --path="$site_path" --allow-root
    else
        # Fallback to wget
        wget -q https://wordpress.org/latest.tar.gz -O /tmp/wordpress.tar.gz
        tar -xzf /tmp/wordpress.tar.gz -C /tmp
        cp -r /tmp/wordpress/* "$site_path/"
        rm -rf /tmp/wordpress /tmp/wordpress.tar.gz
    fi

    # Restore uploads if preserved
    restore_uploads

    # Create wp-config.php
    log "INFO" "Creating wp-config.php..."
    create_wp_config

    # Set permissions
    log "INFO" "Setting file permissions..."
    chown -R "$WEB_USER:$WEB_GROUP" "$site_path"
    find "$site_path" -type d -exec chmod 755 {} \;
    find "$site_path" -type f -exec chmod 644 {} \;

    log "SUCCESS" "WordPress reinstalled successfully"
}

create_wp_config() {
    local site_path="$WEBSITES_ROOT/$DOMAIN/html"
    local wp_config="$site_path/wp-config.php"

    # Generate salts
    local salts=$(curl -s https://api.wordpress.org/secret-key/1.1/salt/ 2>/dev/null || generate_local_salts)

    cat > "$wp_config" << WPCONFIG
<?php
/**
 * WordPress Configuration File
 * Regenerated by JPS Reinstall WordPress
 * Date: $(date '+%Y-%m-%d %H:%M:%S')
 */

// Database settings
define( 'DB_NAME', '$DB_NAME' );
define( 'DB_USER', '$DB_USER' );
define( 'DB_PASSWORD', '$DB_PASSWORD' );
define( 'DB_HOST', '$DB_HOST' );
define( 'DB_CHARSET', 'utf8mb4' );
define( 'DB_COLLATE', '' );

// Authentication unique keys and salts
$salts

// Database table prefix
\$table_prefix = '$TABLE_PREFIX';

// Debug mode
define( 'WP_DEBUG', false );

// Absolute path to the WordPress directory
if ( ! defined( 'ABSPATH' ) ) {
    define( 'ABSPATH', __DIR__ . '/' );
}

// Sets up WordPress vars and included files
require_once ABSPATH . 'wp-settings.php';
WPCONFIG

    chmod 640 "$wp_config"
    chown "$WEB_USER:$WEB_GROUP" "$wp_config"
}

generate_local_salts() {
    # Fallback if WordPress API is unavailable
    local chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{}|;:,.<>?'

    generate_salt() {
        local salt=""
        for i in {1..64}; do
            salt+="${chars:RANDOM%${#chars}:1}"
        done
        echo "$salt"
    }

    cat << EOF
define( 'AUTH_KEY',         '$(generate_salt)' );
define( 'SECURE_AUTH_KEY',  '$(generate_salt)' );
define( 'LOGGED_IN_KEY',    '$(generate_salt)' );
define( 'NONCE_KEY',        '$(generate_salt)' );
define( 'AUTH_SALT',        '$(generate_salt)' );
define( 'SECURE_AUTH_SALT', '$(generate_salt)' );
define( 'LOGGED_IN_SALT',   '$(generate_salt)' );
define( 'NONCE_SALT',       '$(generate_salt)' );
EOF
}

cleanup_on_error() {
    log "ERROR" "An error occurred during reinstall"

    # Restore uploads if they were preserved
    if [[ -n "${TEMP_UPLOADS_PATH:-}" ]] && [[ -d "$TEMP_UPLOADS_PATH" ]]; then
        log "INFO" "Cleaning up temporary uploads..."
        rm -rf "$TEMP_UPLOADS_PATH"
    fi

    if [[ -n "${BACKUP_PATH:-}" ]]; then
        log "INFO" "Backup available at: $BACKUP_PATH"
        log "INFO" "To restore, run: tar -xzf $BACKUP_PATH/files.tar.gz -C $WEBSITES_ROOT/$DOMAIN"
    fi

    json_output "false" "Reinstall failed - backup available at $BACKUP_PATH"
    exit 1
}

main() {
    parse_args "$@"

    # Set up logging
    mkdir -p "$LOG_DIR"
    log_file="$LOG_DIR/${DOMAIN}.log"

    log "INFO" "Starting WordPress reinstall for $DOMAIN"
    log "INFO" "Options: preserve_uploads=$PRESERVE_UPLOADS, force=$FORCE_MODE, json=$JSON_OUTPUT"

    # Set up error handling
    trap cleanup_on_error ERR

    # Validate domain and site
    validate_domain

    # Extract database credentials
    extract_db_credentials

    # Get site info for display
    get_site_info

    # Interactive confirmation (skipped in force mode)
    interactive_confirm

    # Create backup
    create_backup

    # Perform reinstall
    reinstall_wordpress

    # Get new WordPress version
    NEW_WP_VERSION="unknown"
    if [[ -f "$WEBSITES_ROOT/$DOMAIN/html/wp-includes/version.php" ]]; then
        NEW_WP_VERSION=$(grep "wp_version = " "$WEBSITES_ROOT/$DOMAIN/html/wp-includes/version.php" | cut -d "'" -f 2)
    fi

    log "SUCCESS" "WordPress reinstall completed for $DOMAIN"
    log "INFO" "Previous version: $WP_VERSION"
    log "INFO" "New version: $NEW_WP_VERSION"
    log "INFO" "Backup location: $BACKUP_PATH"

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        json_output "true" "WordPress reinstalled successfully" "{\"domain\": \"$DOMAIN\", \"old_version\": \"$WP_VERSION\", \"new_version\": \"$NEW_WP_VERSION\", \"backup_path\": \"$BACKUP_PATH\", \"preserve_uploads\": $PRESERVE_UPLOADS}"
    else
        echo ""
        echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
        echo -e "${GREEN}                    ✓ REINSTALL COMPLETE${NC}"
        echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
        echo ""
        echo "Domain: $DOMAIN"
        echo "Previous WordPress: $WP_VERSION"
        echo "New WordPress: $NEW_WP_VERSION"
        echo "Backup: $BACKUP_PATH"
        if [[ "$PRESERVE_UPLOADS" == "true" ]]; then
            echo "Uploads: Preserved"
        fi
        echo ""
        echo "Next steps:"
        echo "  1. Visit https://$DOMAIN/wp-admin/"
        echo "  2. Reinstall your theme"
        echo "  3. Reinstall required plugins"
        echo "  4. Check that your content is intact"
        echo ""
    fi
}

main "$@"
